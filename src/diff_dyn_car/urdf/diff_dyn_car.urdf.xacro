<?xml version="1.0"?>
<robot name="diff_dyn_car" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- 参数 -->
  <xacro:property name="wheel_radius" value="0.035"/>
  <xacro:property name="wheel_width"  value="0.025"/>
  <xacro:property name="base_length"  value="0.26"/>
  <xacro:property name="base_width"   value="0.11"/>
  <xacro:property name="base_height"  value="0.017"/>

  <!-- base_link -->
  <link name="base_link">
    <visual>
      <geometry>
        <box size="${base_length} ${base_width} ${base_height}"/>
      </geometry>
      <material name="blue">
        <color rgba="0.1 0.3 0.9 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <box size="${base_length} ${base_width} ${base_height}"/>
      </geometry>
    </collision>
    <inertial>
      <mass value="0.5"/>
      <inertia ixx="0.000517" ixy="0.0"    ixz="0.0"
               iyy="0.00283"  iyz="0.0"
               izz="0.00332"/>
    </inertial>
  </link>

  <!-- 轮子宏 -->
  <!-- 轮子宏：带简易“悬挂”的版本 -->
  <xacro:macro name="wheel" params="name x y">
    <!-- 悬挂连杆：在 base_link 和 轮子 中间插一节 -->
    <link name="${name}_susp">
      <inertial>
        <mass value="0.01"/>
        <inertia ixx="1e-5" ixy="0.0" ixz="0.0"
                 iyy="1e-5" iyz="0.0"
                 izz="1e-5"/>
      </inertial>
    </link>

    <!-- 悬挂关节：允许沿 z 方向上下走一小段（模拟压缩） -->
    <joint name="${name}_susp_joint" type="prismatic">
      <parent link="base_link"/>
      <child  link="${name}_susp"/>
      <!-- 位置还是用你之前的 x,y,z -->
      <origin xyz="${x} ${y} -${base_height/2}" rpy="0 0 0"/>
      <!-- z 轴方向：上下弹跳 -->
      <axis xyz="0 0 1"/>
      <!-- 悬挂行程：最多向下压 2 cm -->
      <limit lower="-0.02" upper="0.0" effort="200.0" velocity="1.0"/>
      <!-- 悬挂刚度 + 阻尼：可以再按手感调 -->
      <dynamics spring_stiffness="1500.0" damping="50.0"/>
    </joint>

    <!-- 真正的轮子本体（和你之前一样） -->
    <link name="${name}">
      <visual>
        <origin rpy="1.57079632679 0 0"/>
        <geometry>
          <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
        </geometry>
        <material name="black">
          <color rgba="0.1 0.1 0.1 1"/>
        </material>
      </visual>
      <collision>
        <origin rpy="1.57079632679 0 0"/>
        <geometry>
          <cylinder radius="${wheel_radius}" length="${wheel_width}"/>
        </geometry>
        <surface>
          <contact>
            <ode>
              <!-- 略微可压入地面，避免太硬 -->
              <kp>5e4</kp>
              <kd>2.0</kd>
              <min_depth>0.001</min_depth>
            </ode>
          </contact>
          <friction>
            <ode>
              <!-- 仍然保留你之前设置的摩擦和滑移 -->
              <mu>0.8</mu>
              <mu2>0.8</mu2>
              <slip1>0.2</slip1>   <!-- 纵向滑移 -->
              <slip2>0.2</slip2>   <!-- 横向滑移 -->
            </ode>
          </friction>
        </surface>
      </collision>
      <inertial>
        <mass value="0.025"/>
        <inertia ixx="9.0e-06"  ixy="0.0"    ixz="0.0"
                 iyy="9.0e-06"  iyz="0.0"
                 izz="1.53e-05"/>
      </inertial>
    </link>

    <!-- 保持原来的旋转关节名字：${name}_joint（给 ros2_control 用） -->
    <joint name="${name}_joint" type="continuous">
      <!-- 注意：现在是挂在 悬挂连杆 上 -->
      <parent link="${name}_susp"/>
      <child  link="${name}"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <axis xyz="0 1 0"/>
      <limit effort="5.0" velocity="100.0"/>
      <dynamics damping="0.01" friction="0.1"/>
    </joint>
  </xacro:macro>


  <!-- 四个轮子 -->
  <xacro:wheel name="left_front_wheel"
               x="${0.3 * base_length}"
               y="${ base_width / 2}" />
  <xacro:wheel name="right_front_wheel"
               x="${0.3 * base_length}"
               y="${-base_width / 2}" />
  <xacro:wheel name="left_behind_wheel"
               x="${-0.3 * base_length}"
               y="${ base_width / 2}" />
  <xacro:wheel name="right_behind_wheel"
               x="${-0.3 * base_length}"
               y="${-base_width / 2}" />

  <!-- ros2_control：注意这里用 effort -->
  <ros2_control name="diff_dyn_system" type="system">
    <hardware>
      <plugin>gazebo_ros2_control/GazeboSystem</plugin>
    </hardware>

    <joint name="left_front_wheel_joint">
      <command_interface name="effort"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>
    <joint name="right_front_wheel_joint">
      <command_interface name="effort"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>
    <joint name="left_behind_wheel_joint">
      <command_interface name="effort"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>
    <joint name="right_behind_wheel_joint">
      <command_interface name="effort"/>
      <state_interface name="position"/>
      <state_interface name="velocity"/>
      <state_interface name="effort"/>
    </joint>
  </ros2_control>

  <gazebo>
    <plugin filename="libgazebo_ros2_control.so" name="gazebo_ros2_control">
      <robot_sim_type>gazebo_ros2_control/GazeboSystem</robot_sim_type>
      <robot_param>robot_description</robot_param>
      <robot_param_node>robot_state_publisher</robot_param_node>

      <!-- 先不要 namespace，全部挂在根 / -->
      <!-- <robot_namespace>/diff_dyn_car</robot_namespace> -->

      <!-- 在 xacro 里用 $(find 包名) 语法 -->
      <parameters>$(find diff_dyn_car)/config/diff_dyn_car_ros2_control.yaml</parameters>
    </plugin>
  </gazebo>




</robot>
